# azure-pipelines.yml
# .NET Desktop build + Qwiet preZero scan

trigger:
- master

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

stages:
- stage: BuildAndScan
  displayName: Build and Security Scan
  jobs:

  # --- Job 1: Build & Test on Windows ---
  - job: BuildAndTest
    displayName: Build and Test (.NET Desktop)
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: NuGetToolInstaller@1

    - task: NuGetCommand@2
      inputs:
        restoreSolution: '$(solution)'

    - task: VSBuild@1
      inputs:
        solution: '$(solution)'
        platform: '$(buildPlatform)'
        configuration: '$(buildConfiguration)'

    - task: VSTest@2
      inputs:
        platform: '$(buildPlatform)'
        configuration: '$(buildConfiguration)'

  # --- Job 2: Qwiet preZero Scan on Ubuntu ---
  - job: QwietAIScan
    displayName: Qwiet preZero Scan
    dependsOn: BuildAndTest
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    # Linux install (agent is Ubuntu)
    - task: CmdLine@2
      displayName: Install Qwiet preZero (Linux)
      inputs:
        script: |
          curl -sSL https://cdn.shiftleft.io/download/sl > $HOME/sl && chmod a+rx $HOME/sl
          sudo mv $HOME/sl /usr/local/bin/

    # Analyze (adjust --csharp path if your .sln lives elsewhere)
    - task: CmdLine@2
      displayName: Analyze with Qwiet preZero
      inputs:
        script: |
          sl analyze \
            --wait \
            --verbose \
            --app "$(System.TeamProject)" \
            --tag "branch=$(Build.SourceBranch)" \
            --team "$(SHIFTLEFT_TEAM)" \
            --structured-output \
            --structured-output-format JSON \
            --structured-output-file-path qwiet-analysis-output.json \
            --csharp netcoreWebapi/netcoreWebapi.sln
      env:
        SHIFTLEFT_ACCESS_TOKEN: $(SHIFTLEFT_ACCESS_TOKEN)
        SHIFTLEFT_TEAM: $(SHIFTLEFT_TEAM)

    # Basic quality gate (no build rules)
    - task: CmdLine@2
      displayName: Check Analysis Results (no build rules)
      continueOnError: true
      inputs:
        script: |
          sl check-analysis \
            --v2 \
            --app "$(System.TeamProject)" \
            --no-build-rules \
            --max-findings 50 \
            --report-file qwiet-check-analysis-report.md
      env:
        SHIFTLEFT_ACCESS_TOKEN: $(SHIFTLEFT_ACCESS_TOKEN)
        SHIFTLEFT_TEAM: $(SHIFTLEFT_TEAM)

    # Publish initial reports
    - task: CopyFiles@2
      displayName: Copy Qwiet reports to staging
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)'
        Contents: |
          qwiet-analysis-output.json
          qwiet-check-analysis-report.md
        TargetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: PublishBuildArtifacts@1
      displayName: Publish Artifact:QwietReports
      inputs:
        ArtifactName: QwietReports
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'

    # BestFix report
    - task: CmdLine@2
      displayName: Generate Qwiet BestFix report
      inputs:
        script: |
          git clone https://github.com/ShiftLeftSecurity/field-integrations.git report
          python3 -m pip install --upgrade pip
          pip3 install -r report/shiftleft-utils/requirements.txt
          python3 report/shiftleft-utils/bestfix.py \
            --no-logo \
            -a "$(System.TeamProject)" \
            -f json \
            -o qwiet-bestfix-report.json \
            -s .
        failOnStderr: false
      env:
        SHIFTLEFT_ACCESS_TOKEN: $(SHIFTLEFT_ACCESS_TOKEN)

    - task: CopyFiles@2
      displayName: Copy BestFix report to staging
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)'
        Contents: |
          qwiet-bestfix-report.json
        TargetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: PublishBuildArtifacts@1
      displayName: Publish Artifact:QwietBestFix
      inputs:
        ArtifactName: QwietBestFix
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'

    # SBOM report
    - task: CmdLine@2
      displayName: Generate Qwiet SBOM report
      inputs:
        script: |
          python3 report/shiftleft-utils/sbom_report.py \
            -a "$(System.TeamProject)" \
            -o qwiet-sbom-report.json
        failOnStderr: false
      env:
        SHIFTLEFT_ACCESS_TOKEN: $(SHIFTLEFT_ACCESS_TOKEN)

    - task: CopyFiles@2
      displayName: Copy SBOM report to staging
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)'
        Contents: |
          qwiet-sbom-report.json
        TargetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: PublishBuildArtifacts@1
      displayName: Publish Artifact:QwietSBOM
      inputs:
        ArtifactName: QwietSBOM
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'

    # Optional: Enforce build rules (removed --no-build-rules)
    - task: CmdLine@2
      displayName: Check Analysis Results (with build rules)
      continueOnError: true
      inputs:
        script: |
          sl check-analysis \
            --v2 \
            --config report/build-rules-v2/shiftleft.yml \
            --app "$(System.TeamProject)"
      env:
        SHIFTLEFT_ACCESS_TOKEN: $(SHIFTLEFT_ACCESS_TOKEN)
        SHIFTLEFT_TEAM: $(SHIFTLEFT_TEAM)
